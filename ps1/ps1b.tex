\documentclass[letterpaper, 12pt]{article}

\usepackage{graphicx}
\usepackage{longtable}
\usepackage{rotating}
\usepackage{dcolumn}
\usepackage{listings}

% Code listing commands
\lstset{language=R,
basicstyle=\scriptsize\ttfamily,
commentstyle=\ttfamily,
numbers=left,
numberstyle=\footnotesize,
stepnumber=1,
numbersep=5pt,
showspaces=false,
showstringspaces=false,
showtabs=false,
frame=single,
tabsize=2,
captionpos=b,
breaklines=true,
breakatwhitespace=false,
title=\lstname,
escapeinside={},
keywordstyle={},
morekeywords={}
}

\begin{document}
\title{ARE213 Problem Set \#1B}
\author{Peter Alstone \& Frank Proulx}
\maketitle

\section{Problem \#1}
\subsection{Part A}
\emph{Under the assumption of random assignment conditional on the observables, what are the sources of misspecification bias in the estimates generated by the linear model estimated in Problem Set 1a?}

\paragraph{Wrong functional form.}
In Problem Set 1A we used linear (i.e., $ y = \beta x + \epsilon$) estimators to make ``corrections'' while the true functional form of the relationships between the covariates we included in the modern were certainly not linear.  By imposing a linear function on a non-linear data generating process (described by the CEF), we introduce misspecification bias in the model.  

\paragraph{Omitted Variables Bias.}  We were able to use variables included in the dataset in our linear model, but not the unobserved variables that may be important for control.  If omitted variables exist that both determine outcomes related to birth weight and are correlated with smoking status we will over- or under-estimate the effect (depending on the characteristics of the omission).   


\subsection{Part B}
\emph{Now, consider a series estimator. Estimate the smoking effects using a flexible functional form for the control variables (e.g., higher order terms and interactions). What are the benefits and drawbacks to this approach?}

We can attempt to reduce the magnitude of the first source of bias mentioned above (functional form) by introducing non-parametric series estimators as a replacement for linear regression.  To implement this we used a natural cubic spline with two knots on the ``dmar" variable (maternal age) in the regression from PS1A.  The tobacco use (treatment) and marital status remain as factors.  We also implemented a version of the model with interactions between the splined maternal age term and the two discrete terms.  The summary of the results are in Table \ref{tab:splineresults}.  The ATE for the model we used in PS1A for tobacco use was 200 grams (rounded from an exact estimate of 195 grams).  This is essentially unchanged with the addition splines to the maternal age relationship (an exact estimate of 199 grams).  Adding interaction terms results in an ATE for tobacco use of 220 grams.  

The benefits to applying splines in this case is that the regression model more closely matches the reality of the data, which show that birth weight's relationship to maternal age has a peak and is not monotonically increasing.  The drawback is that the true functional form is only obscured in this approach.  While the interaction terms result in an ATE that is different from the one in a non-interacting model, the interpretation becomes much more difficult.  In a policymaking environment the addition of splines and interactions would represent a potential roadblock to the essential message, which remains unchanged, which is that birth weight is reduced in mothers who use tobacco (by about 200 grams).  


% Table created by stargazer v.4.0 by Marek Hlavac, Harvard University. E-mail: hlavac at fas.harvard.edu% Date and time: Wed, Oct 16, 2013 - 23:09:54\begin{table}[!htbp] \centering   \caption{Comparison of three linear models for birth weight}   \label{tab:splineresults} \begin{tabular}{@{\extracolsep{5pt}}lccc} \\[-1.8ex]\hline \hline \\[-1.8ex] \\[-1.8ex] & \multicolumn{3}{c}{Birth Weight} \\ \\[-1.8ex] & 1) PS1A LM & 2) 1+spline & 3) 2+interaction\\ \hline \\[-1.8ex]  tobacco2 & 195.101$^{***}$ & 199.060$^{***}$ & 252.395$^{***}$ \\   & (4.764) & (4.774) & (84.171) \\   dmage & 2.716$^{***}$ &  &  \\   & (0.338) &  &  \\   ns(dmage, df = 3)1 &  & 147.297$^{***}$ & 85.607$^{**}$ \\   &  & (10.062) & (37.532) \\   ns(dmage, df = 3)2 &  & 342.494$^{***}$ & 386.881$^{**}$ \\   &  & (36.880) & (177.619) \\   ns(dmage, df = 3)3 &  & $-$10.419 & $-$55.186 \\   &  & (25.826) & (104.185) \\   dmar2 & $-$146.507$^{***}$ & $-$123.962$^{***}$ & 57.854 \\   & (4.538) & (4.797) & (85.517) \\   tobacco2:ns(dmage, df = 3)1 &  &  & 101.145$^{**}$ \\   &  &  & (41.432) \\   tobacco2:ns(dmage, df = 3)2 &  &  & $-$68.050 \\   &  &  & (194.021) \\   tobacco2:ns(dmage, df = 3)3 &  &  & 33.670 \\   &  &  & (109.995) \\   tobacco2:dmar2 &  &  & $-$267.716$^{***}$ \\   &  &  & (94.824) \\   ns(dmage, df = 3)1:dmar2 &  &  & $-$135.516$^{***}$ \\   &  &  & (50.824) \\   ns(dmage, df = 3)2:dmar2 &  &  & $-$398.948$^{*}$ \\   &  &  & (214.796) \\   ns(dmage, df = 3)3:dmar2 &  &  & $-$275.447$^{*}$ \\   &  &  & (165.568) \\   tobacco2:ns(dmage, df = 3)1:dmar2 &  &  & 42.062 \\   &  &  & (59.539) \\   tobacco2:ns(dmage, df = 3)2:dmar2 &  &  & 619.892$^{***}$ \\   &  &  & (239.750) \\   tobacco2:ns(dmage, df = 3)3:dmar2 &  &  & 391.482$^{**}$ \\   &  &  & (192.669) \\   Constant & 3,170.698$^{***}$ & 3,040.520$^{***}$ & 2,989.989$^{***}$ \\   & (10.921) & (16.392) & (76.157) \\  \textit{N} & 114,610 & 114,610 & 114,610 \\ R$^{2}$ & 0.037 & 0.039 & 0.040 \\ Adjusted R$^{2}$ & 0.037 & 0.039 & 0.040 \\ \hline \hline \\[-1.8ex] \textit{Notes:} & \multicolumn{3}{r}{$^{***}$Significant at the 1 percent level.} \\  & \multicolumn{3}{r}{$^{**}$Significant at the 5 percent level.} \\  & \multicolumn{3}{r}{$^{*}$Significant at the 10 percent level.} \\ \normalsize \end{tabular} \end{table} 


\section{Problem \#2}

The Propensity Score Method (PSM) uses a ``surrogate'' normalized metric (p-score) as a replacement for the observable controls that would normally be used to condition the estimates of a treatment response to the variable in question.  The p-score is defined as a normalized score that represents the likelihood a sample selects into treatment conditioned on observables.  Because it collapses all the dimensions into a 0:1 continuum PSM avoids the curse of dimensionality encountered with large nonparametric regression models, where it can be difficult to find neighbors or ``bandwidth-mates'' in n-dimensional space.  

\subsection{Part A}

To calculate the propensity score, we estimated a logit model of mother's tobacco use (0=non-smoker, 1=smoker) as determined by the predetermined covariates shown in Table \ref{tab:propensities}. Model \#1 shows the full model using all of the covariates suspected to be predetermined. Model \#2 is a reduced form of the same model, preserving just those covariates that were significant at the 1\% level in Model \#1. 

\let\clearpage\relax
 \input{propensityscores.tex}

To test whether the propensity scores predicted by these two models are significantly different  we perform a likelihood ratio test between  the full and reduced model. This test yields the following output:

\paragraph{Likelihood ratio test for MLE method:} Chi-squared 3 d.f. =  10.21274, P value =  0.01684173 

The likelihood ratio test result (i.e., p $<$ 0.05 but not $<$ 0.01) indicates that the reduced-form model is sufficient for our purposes.

% NOTE from class: including insignificant terms can be beneficial in terms of getting better fit (by reducing 

\subsection{Part B}

This estimation assumes unconfoundedness and a constant treatment effect.

% SECTION BELOW WAS RESULTING IN ERRORS on TeX compilation...commented out for now

\input{propensityscoremodel.tex}

The estimated average treatment effect is given by 
\begin{equation}
\delta_1 + \delta_2 \overline{p}(X_i)=-237.099 + (0.1594 * 90.427)=-222.69
\end{equation}

This suggests that (pursuant to these assumptions) the average effect of smoking on birthweight is a reduction of 223 grams.

\subsection{Part C}

We estimate the average treatment effect of smoking on birthweight to be 222 grams when using the reweighting approach. This approach involved taking a weighted average of all observations using the (normalized inverse) of the propensity score as a weighting factor. This is consistent with the estimate produced using the regression approach.

We estimate the average treatment on the treated to be % We still need to figure this out.

\subsection{Part D}
Here we estimate the density function with a kernel density estimator, using the density() function in R. We estimate the density function separately for the smoking and non-smoking members of the sample, and weight their responses with the propensity scores normalized to the subsample (e.g. $p(X_i)/\sum\limits{j=1}^{N_{smokers}}p(X_j)$)

We estimate the density function using the Epanechnikov kernel and bandwidths ranging from 10 grams to 100 grams in increments of 10 grams. Figure \ref{fig:kernel40} shows the density function estimated with a bandwidth of 40 grams. This bandwidth appears to be a good compromise between washing out some of the noise at lower bandwidths while preserving the underlying CEF. 

\begin{figure}[h!]
   \centering
   \includegraphics[width=6in]{img/kerndensity40.pdf} 
   \caption{Birthweight density function estimates produced using Epanechnikov kernel estimator for smokers and non-smokers.}
   \label{fig:kernel40}
\end{figure}



We also estimate the density at x=3000 grams by hand. We first calculate the average propensity score for both smokers and non-smokers with infants at 3000 grams. The dataset has 12 smokers and 47 non-smokers with infants born at this weight. The average propensity score for these smokers is 0.27 and for non-smokers it is 0.20. These values stand to reason- the people who have opted in to smoking in this class have been predicted as more likely to be smokers.


\subsection{Part E}

Figure \ref{fig:kernelbw} shows how the character of the kernel density estimator is effected by the choice of bandwidth for the problem at hand.  While all the kernel densities tend to tell the same story, those with ``middle" bandwidth are a good balance between the choppy nature of small bandwidth and over-smoothing of large bandwidth.

\begin{figure}[h!]
   \centering
   \includegraphics[width=6in]{img/kdens-combinebw.pdf} 
   \caption{Comparison of bandwidth choices for birthweight density function estimates produced using Epanechnikov kernel estimator for smokers and non-smokers.}
   \label{fig:kernelbw}
\end{figure}

\subsection{Part F}

The weighting approach in Part C offers a way to use propensity scores in a regression model, so it is possible to ``tell a story" with the results that is accessible to people who are comfortable with regression models.  TODO: Add text here. 

The potential downside to the weighting scheme is that outlier values (very high or low propensity scores) for those who went ``against" their propensity (i.e., for a low score, they selected to treatment or vice versa) will have very high weight (approaching infinity in the limit).  It is possible to mitigate this issue by trimming the data to only consider people with propensity scores between 10 \% and 90\%, for instance.  

\subsection{Part G}
Using a range of propensity scoring methods we find that the average effect of smoking on birth weight is 220 grams (lower weight for mothers who smoke).  Both regression adjustment and reweighing methods resulted in essentially the same result, which matches the result of using cubic splines and interaction in a regression model.  

TODO: Finish writing interpretation.
\section{Problem \# 3}

\section{Problem \#4}

\section{Problem \#5}


\section{Code}
We used R to complete this assignment.  The code is below:

\lstinputlisting{ps1b.R}
\lstinputlisting{../util/are213-func.R}

\newpage
\thispagestyle{empty}
\mbox{}
\end{document}
